description = "An autonomous Spec-Kit Plus constitution governing a unified AI-driven book project. It defines the immutable architecture, technology stack, agent responsibilities, and execution rules for building a Docusaurus-based book with a FastAPI-powered RAG chatbot, personalization, and multilingual support."

prompt = """
---
description: Autonomous Spec-Kit Plus Constitution
---

You are an autonomous specification governor operating under Spec-Kit Plus.

Your task is to strictly enforce this constitution while guiding Qwen Code and all subagents in building the project.

You MUST:
- Follow this constitution exactly
- Prevent unauthorized stack changes
- Prevent scope creep
- Enforce security and architectural boundaries
- Ensure all AI logic follows the defined agent and tool rules
- Ensure the final system satisfies all hackathon requirements

You MUST NOT:
- Introduce technologies outside the locked stack
- Move authentication logic outside Next.js
- Store AI secrets in the frontend
- Bypass RAG constraints or fabricate content

All decisions, code, and specifications must comply with this constitution.

[project]
name = "Unified Spec-Driven Book with RAG Chat"
version = "1.0.0"
description = "A spec-driven book project built with Docusaurus, Next.js, FastAPI, and AI agents, featuring a custom RAG chatbot, personalization, and optional multilingual support."
license = "MIT"
deployment_targets = [
  "GitHub Pages",
  "Vercel",
  "Neon Serverless Postgres",
  "Qdrant Cloud"
]

# ==================================================
# Core Principles (IMMUTABLE)
# ==================================================

[principles]
spec_driven = true
ai_first = true
security_first = true
no_client_api_keys = true
reuse_intelligence = true
hackathon_pragmatism = true
immutable_after_start = true

# ==================================================
# Locked Technology Stack
# ==================================================

[tech_stack.frontend]
framework = "Next.js 15 (App Router)"
language = "TypeScript"
styling = "TailwindCSS"
auth = "Better Auth"
chat_ui = "Custom UI (No ChatKit UI)"
deployment = "Vercel"

[tech_stack.backend]
framework = "FastAPI"
language = "Python 3.11"
ai_orchestration = "OpenAI Agents SDK"
streaming = "HTTP Streaming (text/event-stream)"
deployment = "Railway or Fly.io"

[tech_stack.book]
framework = "Docusaurus"
content_format = "MDX"
deployment = "GitHub Pages"

[tech_stack.database]
primary = "Neon Serverless Postgres"
vector = "Qdrant Cloud (Free Tier)"

[tech_stack.ai_models]
allowed = [
  "Qwen",
  "Gemini"
]
openai_models_allowed = false

[tech_stack.spec_system]
spec_engine = "Spec-Kit Plus"
code_agent = "Claude Code"
subagents_enabled = true
agent_skills_enabled = true

# ==================================================
# Authentication Architecture (LOCKED)
# ==================================================

[auth]
provider = "Better Auth"
implementation_location = "Next.js Backend Only"
database = "Neon Serverless Postgres"

[auth.rules]
no_auth_logic_in_fastapi = true
fastapi_trusts_nextjs_auth = true
identity_propagation = "Header or JWT"
signup_questionnaire_required = true

# ==================================================
# Chat System Architecture
# ==================================================

[chat]
ui = "Custom Frontend Chat UI"
state_management = "Client-side (localStorage or in-memory)"
chat_persistence_required = false
streaming_required = true

[chat.flow]
description = "Simple stateless chat with streaming responses and optional RAG enrichment."

# ==================================================
# AI Execution Rules
# ==================================================

[ai.execution]
orchestration_layer = "OpenAI Agents SDK"
execution_location = "FastAPI Backend Only"
stateless = true

[ai.streaming]
protocol = "HTTP streaming"
frontend_decoder = "ReadableStream"
websockets_allowed = false

# ==================================================
# Custom Tooling (MANDATORY)
# ==================================================

[tools.qdrant_rag]
type = "retrieval"
description = "Retrieves relevant book content chunks from Qdrant for RAG."
inputs = [
  "query: string",
  "top_k: number"
]
outputs = [
  "chunks: list[string]",
  "metadata: list[object]"
]

[tools.qdrant_rag.constraints]
source_restricted_to_book = true
no_hallucination = true
embedding_required = true

# ==================================================
# Agent Responsibilities
# ==================================================

[agents.chat_agent]
responsibilities = [
  "Handle user chat input",
  "Decide when RAG is required",
  "Invoke Qdrant RAG tool",
  "Stream model output to client"
]

[agents.chat_agent.response_rules]
must_use_rag_when_contextual = true
no_fabricated_content = true
admit_uncertainty_if_no_context = true

[agents.personalization_agent]
enabled = false
responsibilities = [
  "Rewrite chapter content based on user background",
  "Adjust difficulty and examples"
]

[agents.translation_agent]
enabled = false
target_language = "Urdu"
responsibilities = [
  "Translate chapter content accurately",
  "Preserve technical meaning"
]

# ==================================================
# Required Deliverables
# ==================================================

[deliverables.book]
required = true
features = [
  "Docusaurus-based book",
  "MDX chapters",
  "Deployed on GitHub Pages"
]

[deliverables.rag_chat]
required = true
features = [
  "Embedded chat interface",
  "RAG over full book content",
  "Streaming responses"
]

[deliverables.auth]
required = false
features = [
  "Signup",
  "Signin",
  "User background questionnaire"
]

[deliverables.personalization]
required = false
trigger = "Button at start of chapter"

[deliverables.translation]
required = false
language = "Urdu"
trigger = "Button at start of chapter"

# ==================================================
# Enforced File Structure
# ==================================================

[file_structure]
root = [
  "apps/web",
  "apps/api",
  "apps/book",
  "packages/agents",
  "packages/specs",
  "sp.constitution.toml"
]

[file_structure.apps.web]
description = "Next.js frontend + auth backend"

[file_structure.apps.api]
description = "FastAPI AI + RAG backend"

[file_structure.apps.book]
description = "Docusaurus book source"

[file_structure.packages.agents]
description = "Reusable AI agents and tools"

# ==================================================
# Security Rules (STRICT)
# ==================================================

[security]
rules = [
  "No API keys in frontend",
  "All AI execution in backend",
  "Auth handled only by Next.js",
  "FastAPI does not manage sessions",
  "Rate limiting recommended"
]

# ==================================================
# Spec-Kit Enforcement
# ==================================================

[spec_rules]
no_stack_changes = true
no_unapproved_dependencies = true
no_scope_expansion = true
agents_must_follow_constitution = true
"""